<ion-app>
  <ion-header>
    <ion-toolbar>
      <ion-segment [(ngModel)]="selectedTab" color="primary">
        <ion-segment-button value="details">Details</ion-segment-button>
        <ion-segment-button value="expertise">Expertise</ion-segment-button>
      </ion-segment>
    </ion-toolbar>
  </ion-header>
  <ion-content class="ion-padding">
    @if (loading) {
    <standalone-spinner message="Loading users..."></standalone-spinner> } @else
    {
    <ion-list class="horizontal-list">
      @for (user of users; track user.user_id) {
      <standalone-user
        [user]="user"
        (click)="showUser(user)"
        [class.selected]="selectedUser?.user_id === user.user_id  || (!selectedUser && currentUser?.user_id === user.user_id)"
      ></standalone-user>
      } @empty {
      <p>No users available.</p>
      }
    </ion-list>
    } @if (selectedTab === 'details') {
    <!-- Displayed User Profile -->
    @if (displayedUser) {
    <ion-card class="user-profile-card">
      <ion-card-header>
        <div class="header-container">
          <div class="user-info">
            <ion-card-title
              >{{ displayedUser.name || '—' }} @if (displayedUser.verified) {
              <ion-icon name="book"></ion-icon>
              }</ion-card-title
            >
            <ion-card-subtitle
              >{{ displayedUser.email || '—' }}</ion-card-subtitle
            >
          </div>
          <div class="user-flag">
            <span
              [class]="'fi fi-' + (displayedUser.country?.code?.toLowerCase() || '')"
              style="font-size: 3rem"
            ></span>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <div class="info-grid">
          <div>
            <strong>Country:</strong> {{ displayedUser.country?.name || '—' }}
          </div>
          <div><strong>Gender:</strong> {{ displayedUser.gender || '—' }}</div>
          <div><strong>User ID:</strong> {{ displayedUser.user_id }}</div>
        </div>
        <div class="info-grid">
          <div>
            <strong>Date of Birth:</strong> {{ displayedUser.date_of_birth ||
            '—' | dateFormat}}
          </div>
        </div>
        <div class="info-grid">
          <div>
            <strong>Joined:</strong> {{ displayedUser.date_joined || '—' |
            dateFormat}}
          </div>
        </div>
        @if (selectedUser) {
        <ion-button color="medium" (click)="showCurrentUser()" expand="block">
          Back to My Profile
        </ion-button>
        } @else {
        <ion-button
          color="primary"
          (click)="openEditModal(currentUser)"
          expand="block"
        >
          Edit User
        </ion-button>
        <ion-button
          color="primary"
          expand="block"
          (click)="verifyStatus()"
          [disabled]="currentUser?.verified"
        >
          Verify Historian Status
        </ion-button>
        }
      </ion-card-content>
    </ion-card>
    } @if (!showForm) { } @if (showForm) { @if (loadingBlockchain) {
    <standalone-spinner
      message="Loading blockchain data..."
    ></standalone-spinner>
    } @else {
    <form
      class="form-container"
      (submit)="
        registerHistorian(historianName, historianInstitution);
        $event.preventDefault()
      "
    >
      <ion-button expand="block" (click)="connectMetaMask()" type="button">
        {{ account ? "Connected!" : "Connect MetaMask" }}
      </ion-button>

      <ion-item>
        <ion-label position="floating">Name</ion-label>
        <ion-input
          [(ngModel)]="historianName"
          name="name"
          [disabled]="!account || isRegistered"
        ></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Institution</ion-label>
        <ion-input
          [(ngModel)]="historianInstitution"
          name="institution"
          [disabled]="!account || isRegistered"
        ></ion-input>
      </ion-item>

      <ion-button
        expand="block"
        type="submit"
        [disabled]="!account || isRegistered"
        style="margin-top: 12px"
      >
        {{ isRegistered ? "Already Registered" : "Register as Historian" }}
      </ion-button>

      <ion-button
        expand="block"
        type="button"
        (click)="getHistorianInfo()"
        [disabled]="!account"
        style="margin-top: 12px"
      >
        Get My Info
      </ion-button>
      <ion-button
        expand="block"
        type="button"
        (click)="showForm = !showForm"
        style="margin-bottom: 16px"
        color="danger"
      >
        Close Form
      </ion-button>
    </form>
    @if (isRegistered && account) {
    <ion-card style="margin-top: 24px">
      <ion-card-header>
        <ion-card-title>Historian Tools</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <form (submit)="$event.preventDefault(); createNewTopic()">
          <ion-item>
            <ion-label position="floating">Name</ion-label>
            <ion-input
              [(ngModel)]="newTopic.name"
              name="name"
              required
            ></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Area</ion-label>
            <ion-textarea
              [(ngModel)]="newTopic.area_name"
              name="area_name"
              required
            ></ion-textarea>
          </ion-item>
          <ion-button expand="block" type="submit" style="margin-top: 20px"
            >Submit Fact</ion-button
          >
        </form>
      </ion-card-content>
    </ion-card>
    <ion-card style="margin-top: 24px">
      <ion-card-header>
        <ion-card-title> Messages</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <form
          class="form-container"
          (submit)="postMessage(historianMessage); $event.preventDefault()"
        >
          <ion-item>
            <ion-label position="floating">Message</ion-label>
            <ion-input
              [(ngModel)]="historianMessage"
              name="message"
              [disabled]="!account"
            ></ion-input>
          </ion-item>

          <ion-button
            expand="block"
            type="submit"
            [disabled]="!account"
            style="margin-top: 12px"
          >
            Post Message
          </ion-button>

          <ion-button
            expand="block"
            type="button"
            (click)="showMessages()"
            style="margin-bottom: 16px"
          >
            Show Messages
          </ion-button>
        </form>
      </ion-card-content>
    </ion-card>

    } }} } @if (selectedTab==='expertise') { @if (expertises.length) { @for
    (expertise of expertises; track expertise.expertise_id) {
    <standalone-expertise [expertise]="expertise"></standalone-expertise>
    } } @else {
    <p>No expertise.</p>
    } @if (selectedUser) { } @else {
    <form (submit)="$event.preventDefault(); createExpertise()">
      <ion-item>
        <ion-label position="floating">Area</ion-label>
        <ion-input
          (click)="handleAreaInputClick()"
          [(ngModel)]="areaSearch"
          [readonly]="selectedArea"
          name="areaSearch"
          (ionInput)="searchAreas(($event.target.value ?? '').toString())"
          placeholder="Search area..."
          required
        ></ion-input>
      </ion-item>
      @if (areas.length && !selectedArea) {
      <ion-list class="fade-in">
        @for (area of areas; track area.area_id) {
        <ion-item button (click)="selectArea(area)"> {{ area.name }} </ion-item>
        }
      </ion-list>
      }
      <ion-button expand="block" type="submit" style="margin-top: 20px"
        >Create Expertise</ion-button
      >
    </form>
    } }
  </ion-content>
</ion-app>
