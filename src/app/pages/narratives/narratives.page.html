<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Narratives</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  @if (!aiSummary) {
  <!-- Topic search input -->
  <ion-item>
    <ion-label position="floating">Topic</ion-label>
    <ion-input
      [(ngModel)]="topicSearch"
      (ionInput)="searchTopics(($event.target.value ?? '').toString())"
      [readonly]="selectedTopic"
      placeholder="Search topic..."
    ></ion-input>
    <ion-button
      *ngIf="selectedTopic"
      fill="clear"
      (click)="clearTopic()"
      slot="end"
      class="clear-btn"
      >✕</ion-button
    >
  </ion-item>

  <!-- Search results dropdown -->
  <ion-list *ngIf="topics.length && !selectedTopic" class="fade-in">
    <ion-item button *ngFor="let topic of topics" (click)="selectTopic(topic)">
      {{ topic.name }} ({{ topic.area?.name }})
    </ion-item>
  </ion-list>

  <!-- Optional filters -->
  <ion-item>
    <ion-label>Countries</ion-label>
    <ion-select
      [(ngModel)]="selectedCountries"
      multiple="true"
      placeholder="Select countries"
    >
      <ion-select-option
        *ngFor="let country of countries"
        [value]="country.country_id"
      >
        {{ country.name }}
      </ion-select-option>
    </ion-select>
  </ion-item>

  <ion-item>
    <ion-label>Genders</ion-label>
    <ion-select
      [(ngModel)]="selectedGenders"
      multiple="true"
      placeholder="Select genders"
    >
      <ion-select-option *ngFor="let gender of genders" [value]="gender">
        {{ gender }}
      </ion-select-option>
    </ion-select>
  </ion-item>

  <ion-item>
    <ion-label>Age Range</ion-label>
    <ion-select
      [(ngModel)]="selectedAgeRange"
      multiple="true"
      placeholder="Select age range"
    >
      <ion-select-option *ngFor="let range of ageRanges" [value]="range">
        {{ range.label }}
      </ion-select-option>
    </ion-select>
  </ion-item>
  <ion-item>
    <ion-label>Expertise Level</ion-label>
    <ion-select
      [(ngModel)]="selectedVerified"
      placeholder="Select verification"
    >
      <ion-select-option [value]="true">Historian</ion-select-option>
      <ion-select-option [value]="false">Unverified</ion-select-option>
    </ion-select>
  </ion-item>
  <!-- Ideologije -->
  <div class="ideology-filter">
    <ion-item lines="full" class="filter-item">
      <ion-label class="axis-label">Economic</ion-label>
      <ion-segment [(ngModel)]="economicValue" class="axis-segment">
        <ion-segment-button value="left">
          <ion-label>Left</ion-label>
        </ion-segment-button>
        <ion-segment-button value="neutral">
          <ion-label>✕</ion-label>
        </ion-segment-button>
        <ion-segment-button value="right">
          <ion-label>Right</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-item>

    <ion-item lines="full" class="filter-item">
      <ion-label class="axis-label">Authority</ion-label>
      <ion-segment [(ngModel)]="authorityValue" class="axis-segment">
        <ion-segment-button value="libertarian">
          <ion-label>Less</ion-label>
        </ion-segment-button>
        <ion-segment-button value="neutral">
          <ion-label>✕</ion-label>
        </ion-segment-button>
        <ion-segment-button value="authoritarian">
          <ion-label>More</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-item>

    <ion-item lines="full" class="filter-item">
      <ion-label class="axis-label">Social</ion-label>
      <ion-segment [(ngModel)]="socialValue" class="axis-segment">
        <ion-segment-button value="conservative">
          <ion-label>Trad</ion-label>
        </ion-segment-button>
        <ion-segment-button value="neutral">
          <ion-label>✕</ion-label>
        </ion-segment-button>
        <ion-segment-button value="progressive">
          <ion-label>Prog</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-item>
  </div>

  <ion-button expand="block" (click)="seeAISummary()"
    >Generate AI Summary</ion-button
  >
  } @if (loading) {
  <standalone-spinner message="Building a narrative..."></standalone-spinner>
  } @else {
  <p *ngIf="aiSummary" class="ai-summary">{{ aiSummary }}</p>
  <div *ngIf="sources.length" class="sources-list">
    <p>Sources:</p>
    <ul>
      <li *ngFor="let source of sources">{{ source }}</li>
    </ul>
  </div>

  <ion-button *ngIf="aiSummary" expand="block" (click)="clearNarrative()">
    Clear Narrative
  </ion-button>
  }
</ion-content>
